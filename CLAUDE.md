# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリで作業する際のガイダンスを提供します。

## プロジェクト規約

- **使用言語**: このプロジェクトでのやり取りは日本語で行います
- **ドキュメント**: 生成する.mdファイルは日本語で記述します

## プロジェクト概要

UDPホールパンチングを使用したGo言語によるNATトラバーサル実装です。システムは2つの主要コンポーネントで構成されています：
- **Broker** (`broker.go`): ピアとその公開エンドポイントのレジストリを管理するランデブーサーバー
- **Peer** (`peer.go`): ブローカーに登録し、直接P2P接続を確立するクライアントアプリケーション

### プロジェクトの変遷

最近の主要な変更（コミット履歴より）：
- ブローカーのポート番号を変更 (8d82cd4)
- モジュールサポートとメッセージ形式の変更 (fc08e25)
- ファイルのリネーム (3fc117f)
- 初期実装 (3f250d9)

### アーキテクチャ

#### 通信プロトコル

ブローカーとピア間の通信は、UDP上のテキストベースのシンプルなプロトコルに従います：

**クライアント → ブローカー:**
- `REG <name> <address>`: ピアが名前とアドレスをブローカーに登録
  - 例: `REG peerA 192.168.1.100:65432`
- `GET <name>`: 他のピアのアドレスを問い合わせ
  - 例: `GET peerZ`

**ブローカー → クライアント:**
- `OK <data>`: リクエスト成功、データを返す
  - REGの場合: `OK 203.0.113.45:65432` (登録されたパブリックアドレス)
  - GETの場合: `OK 203.0.113.46:65432` (問い合わせたピアのアドレス)
- `NF `: 指定された名前のピアが見つからない (Not Found)
- `NG `: 無効なコマンド (No Good)

#### データ管理

- **キャッシュ**: github.com/patrickmn/go-cache を使用
  - デフォルト有効期限: 5分 (broker.go:29)
  - クリーンアップ間隔: 10分 (broker.go:29)
  - REGコマンドで登録されたピアは有効期限なし (cache.NoExpiration) に設定 (broker.go:56)
- **バッファサイズ**: UDPパケット受信用に4096バイトのバッファを使用 (broker.go:30, peer.go:59)

#### 並行処理

peer.goでは2つのゴルーチンを使用：
1. **server()** (peer.go:58): UDPメッセージの受信を継続的に処理
2. **client()** (peer.go:69): 5秒間隔でリモートピアにメッセージを送信 (peer.go:81)

### 重要な設計上の決定事項

1. **ハードコードされたブローカーエンドポイント**: ピアアプリケーションは現在 `prgmr.nohohon.jp:65432` をブローカーアドレスとして使用しています (peer.go:16)。ローカルで実行する場合は、これを変更するか、独自のブローカーを実行する必要があります。

2. **固定ポート**: ブローカーとピアの両方がデフォルトでUDPポート65432を使用します。ブローカーは0.0.0.0:65432にバインド (broker.go:15)、ピアはローカルで同じポートにバインドします (peer.go:13)。

3. **ピア名**: peer.goでは、`localName` と `remoteName` が "peerA" と "peerZ" としてハードコードされています (peer.go:14-15)。複数のピアを実行する場合は、これらを変更する必要があります。

4. **接続フロー**: ピアはまず登録 (REG) を行い、NATバインディングのために約10秒待機してから (peer.go:42)、リモートピアのアドレスを問い合わせ (GET) て、P2P通信を確立します。

5. **エラーハンドリング**: エラー発生時はlog.Fatal()で即座にプログラムを終了します。リトライ機構はありません。

6. **メッセージ形式**: ピア間のP2P通信では `<name> <counter>` 形式のメッセージを送信します (peer.go:72)。例: `peerA 0`, `peerA 1`, ...

### 依存関係

- **Go バージョン**: 1.20.0以上 (go.mod:3)
- **外部ライブラリ**:
  - `github.com/patrickmn/go-cache v2.1.0+incompatible`: インメモリキャッシュ（ブローカーのみ使用）

## 開発コマンド

### ビルド
```bash
# ブローカーをビルド
go build -o broker broker.go

# ピアをビルド
go build -o peer peer.go
```

### 実行
```bash
# ブローカーを実行（最初に実行する必要があります）
go run broker.go

# ピアを実行（別のターミナルで、事前にlocalName/remoteNameを変更）
go run peer.go
```

### 依存関係
```bash
# 依存関係のインストール/更新
go mod download

# 依存関係の整理
go mod tidy
```

### テストセットアップ

現在、自動テストはありません。NATトラバーサルを手動でテストするには：
1. 公開サーバーまたはローカルでブローカーを実行
2. peer.goを変更して、各ピアインスタンスに一意のlocalNameを設定
3. 最初のピア（例：peerA）を実行 - REGして待機します
4. 2番目のピア（例：peerZ）を実行 - P2P接続が確立されるはずです
5. ログで正常なメッセージ交換を確認

## コード構造

### broker.go
単一ファイルのUDPサーバー。主要な処理フロー：
1. UDP接続をリスン (broker.go:23)
2. 無限ループでパケットを受信 (broker.go:32-67)
3. メッセージをスペースで分割してコマンド解析 (broker.go:41)
4. switchステートメントでコマンド処理 (broker.go:46-60)
   - `GET`: キャッシュから検索して返す
   - `REG`: リモートアドレスをキャッシュに保存
   - その他: エラーレスポンス

### peer.go
4つの主要な関数を持つ単一ファイルのピアクライアント：

#### main() (peer.go:12)
1. 設定値の定義 (host, localName, remoteName, broker)
2. UDPアドレスの解決とリスン
3. ブローカーに自身を登録 (regLocal)
4. 10秒待機（NATホールパンチング用）
5. リモートピアのアドレスを取得 (getRemote)
6. 2つのゴルーチンを起動（server, client）
7. 無限ループで待機

#### regLocal() (peer.go:85)
- ブローカーに `REG <name> <address>` メッセージを送信
- `OK` レスポンスを待機して検証
- 失敗時はlog.Fatalで終了

#### getRemote() (peer.go:108)
- ブローカーに `GET <name>` メッセージを送信
- `OK <address>` レスポンスからアドレスを抽出
- UDPAddrに変換して返す

#### server() (peer.go:58)
- ゴルーチンとして実行
- UDPメッセージを継続的に受信してログ出力

#### client() (peer.go:69)
- ゴルーチンとして実行
- 5秒間隔でリモートピアにカウンター付きメッセージを送信

## よくある変更

このコードベースで作業する際に、頻繁に必要となる変更：

### 必須の変更（複数ピアを実行する場合）
- **peer.go:14-15**: `localName` と `remoteName` を変更
  - 例: ピアA → `localName = "peerA"`, `remoteName = "peerB"`
  - 例: ピアB → `localName = "peerB"`, `remoteName = "peerA"`

### 環境に応じた変更
- **peer.go:16**: ブローカーアドレス
  - ローカルテスト: `broker = "localhost:65432"`
  - 本番: 実際のブローカーサーバーのアドレス
- **peer.go:13**: ピアのローカルバインドアドレス
  - デフォルト: `0.0.0.0:65432`
  - ポート競合時: ポート番号を変更
- **broker.go:15**: ブローカーのバインドアドレス
  - デフォルト: `0.0.0.0:65432`

### チューニング可能な値
- **peer.go:42**: NATバインディング待機時間（デフォルト: 10秒）
- **peer.go:81**: P2Pメッセージ送信間隔（デフォルト: 5秒）
- **broker.go:29**: キャッシュの有効期限（デフォルト: 5分）とクリーンアップ間隔（10分）

## トラブルシューティング

### よくある問題

1. **"bind: address already in use"**
   - 原因: ポート65432が既に使用中
   - 解決: peer.go:13 または broker.go:15 のポート番号を変更

2. **ピア間の通信が確立しない**
   - REGとGETの間に十分な待機時間があるか確認 (peer.go:42)
   - 両方のピアが正しくブローカーに登録されているか確認
   - ファイアウォールがUDP 65432をブロックしていないか確認

3. **"GET failed"**
   - 原因: リモートピアがまだ登録されていない
   - 解決: リモートピアを先に起動するか、待機時間を増やす

## セキュリティ上の注意

- このコードは教育/実験目的のものです
- 認証機構がありません（誰でもピアを登録/照会可能）
- 暗号化されていません（平文通信）
- 本番環境で使用する場合は、適切な認証と暗号化の実装が必要です
