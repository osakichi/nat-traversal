# NAT Traversal

UDPホールパンチングを使用したシンプルなNATトラバーサル実装です。ブローカーサーバーを介して、NAT配下の2つのピア間で直接P2P通信を確立します。

## 特徴

- **シンプルな実装**: Go言語による軽量なUDPベースの実装
- **ブローカー・ピアアーキテクチャ**: ランデブーサーバー経由でピアを発見
- **UDPホールパンチング**: NAT越えのP2P通信を実現
- **テキストベースプロトコル**: デバッグが容易なシンプルなコマンド形式

## 前提条件

- Go 1.20.0以上

## インストール

### リポジトリのクローン

```bash
git clone <repository-url>
cd nat-traversal
```

### 依存関係のインストール

```bash
go mod download
```

### ビルド

```bash
# ブローカーをビルド
go build -o broker broker.go

# ピアをビルド
go build -o peer peer.go
```

## 使い方

### 1. ブローカーの起動

まず、ブローカーサーバーを起動します。これはピア間の仲介役として動作します。

```bash
# ソースから直接実行
go run broker.go

# またはビルド済みバイナリを実行
./broker
```

ブローカーはデフォルトで `0.0.0.0:65432` でリッスンします。

### 2. ピアの設定と起動

2つのピアを起動する前に、それぞれのピアで `peer.go` の設定を変更します。

**ピアA（peer.go の14-16行目）:**
```go
localName := "peerA"
remoteName := "peerB"
broker := "localhost:65432"  // ローカルテストの場合
```

**ピアB（peer.go の14-16行目）:**
```go
localName := "peerB"
remoteName := "peerA"
broker := "localhost:65432"  // ローカルテストの場合
```

### 3. ピアの実行

```bash
# ターミナル1: ピアAを起動
go run peer.go

# ターミナル2: ピアBを起動（別のターミナルで）
go run peer.go
```

### 実行例

**ブローカーのログ:**
```
2024/11/07 12:00:00 Recv 192.168.1.100:65432 : REG peerA 192.168.1.100:65432
2024/11/07 12:00:00 Send 192.168.1.100:65432 : OK 192.168.1.100:65432
2024/11/07 12:00:05 Recv 192.168.1.101:65432 : REG peerB 192.168.1.101:65432
2024/11/07 12:00:05 Send 192.168.1.101:65432 : OK 192.168.1.101:65432
2024/11/07 12:00:10 Recv 192.168.1.100:65432 : GET peerB
2024/11/07 12:00:10 Send 192.168.1.100:65432 : OK 192.168.1.101:65432
```

**ピアのログ:**
```
2024/11/07 12:00:00 REG success : peerA = 192.168.1.100:65432
2024/11/07 12:00:10 GET success : peerB = 192.168.1.101:65432
2024/11/07 12:00:10 Send 192.168.1.101:65432 : peerA 0
2024/11/07 12:00:11 Recv 192.168.1.101:65432 : peerB 0
2024/11/07 12:00:15 Send 192.168.1.101:65432 : peerA 1
2024/11/07 12:00:16 Recv 192.168.1.101:65432 : peerB 1
```

## 仕組み

### アーキテクチャ

```
┌─────────┐          ┌─────────┐
│ Peer A  │          │ Peer B  │
└────┬────┘          └────┬────┘
     │                    │
     │ 1. REG peerA       │
     │─────────┐          │
     │         ↓          │
     │    ┌─────────┐     │
     │    │ Broker  │     │
     │    └─────────┘     │
     │         ↑          │
     │         │──────────┘
     │         │ 2. REG peerB
     │         │
     │ 3. GET peerB       │
     │─────────┐          │
     │         ↓          │
     │    ┌─────────┐     │
     │    │ Broker  │     │
     │    └─────────┘     │
     │         │          │
     │ 4. OK (peerB addr) │
     │←────────┘          │
     │                    │
     │ 5. P2P通信         │
     │←──────────────────→│
```

### プロトコル

**コマンド:**
- `REG <name> <address>`: ピアをブローカーに登録
- `GET <name>`: 他のピアのアドレスを取得

**レスポンス:**
- `OK <data>`: 成功
- `NF`: ピアが見つからない (Not Found)
- `NG`: 無効なコマンド (No Good)

### 接続フロー

1. 各ピアがブローカーに自身を登録（REG）
2. 約10秒待機（NATバインディングの確立）
3. ピアAがピアBのアドレスをブローカーに問い合わせ（GET）
4. ブローカーがピアBのパブリックアドレスを返す
5. ピアA→ピアBへUDPパケットを送信（NATホールパンチング）
6. 双方向のP2P通信が確立

## 設定

### ポート番号の変更

**ブローカー (broker.go:15):**
```go
local := "0.0.0.0:65432"  // お好みのポートに変更
```

**ピア (peer.go:13):**
```go
host := "0.0.0.0:65432"  // お好みのポートに変更
```

### タイミングの調整

**NATバインディング待機時間 (peer.go:42):**
```go
time.Sleep(10 * time.Second)  // 環境に応じて調整
```

**メッセージ送信間隔 (peer.go:81):**
```go
time.Sleep(5 * time.Second)  // お好みの間隔に変更
```

## トラブルシューティング

### ポート競合エラー
```
bind: address already in use
```
→ `broker.go:15` または `peer.go:13` のポート番号を変更してください。

### GET failed エラー
```
GET failed : peerB
```
→ リモートピアがまだ登録されていません。リモートピアを先に起動するか、待機時間を増やしてください。

### ピア間通信が確立しない
- REGとGETの間に十分な待機時間（10秒）があることを確認
- ファイアウォールがUDPポートをブロックしていないか確認
- 両方のピアのログでREG/GETが成功していることを確認

## セキュリティ上の注意

⚠️ **このコードは教育・実験目的のものです**

- 認証機構がありません（誰でもピアを登録/照会可能）
- 暗号化されていません（平文通信）
- 本番環境で使用する場合は、適切な認証と暗号化の実装が必要です

## 依存関係

- [github.com/patrickmn/go-cache](https://github.com/patrickmn/go-cache) - インメモリキャッシュ（ブローカー用）

## ライセンス

MIT License - 詳細は [LICENSE](LICENSE) ファイルを参照してください。

## 参考資料

- [UDP Hole Punching](https://en.wikipedia.org/wiki/UDP_hole_punching)
- [NAT Traversal](https://en.wikipedia.org/wiki/NAT_traversal)
